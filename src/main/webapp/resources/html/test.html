$(document).ready(function(){
	$("#profileImg").click(function(){
		$("#input_img").click() ;
		})			
	})

</script>


<script>
var header = $("meta[name='_csrf_header']").attr("content");
        var token = $("meta[name='_csrf']").attr("content");
        
        //프로필 등록
        $("#profileform").submit(fucntion(e) {
        	e.preventDefault();
        	var ufilen = $("#ufilename").val();
        	if(ufilen==null||ufilen=="")
        		alert("사진을 추가해주세요.");
        	
        	$(this).submit();
        });
        
        
        $("#uploadphoto").on("change", fileChange);
        function fileChange(e){
        	e.preventDefault();
        	var files = e.target.files;
        	/* for(var key in files){
        		console.log(files[key]);
        	} */
        	var file = files[0];
        	var formData = new FormData();
     	    formData.append("file", file);
     	    console.log(formData.get('file'));
     	    // 파일 업로드 AJAX 통신 메서드 호출
     	    uploadFile(formData);
        }
    	
    	//파일 업로드 AJAX 통신
    	function uploadFile(formData){
    		$.ajax({
    			url:"${pageContext.request.contextPath}/files/upload",
    			data:formData,
    			dataType:"text",
    			processData:false,
    			contentType:false,
    			type:"POST",
    			beforeSend: function(xhr){
    				xhr.setRequestHeader(header, token);	// 헤드의 csrf meta태그를 읽어 CSRF 토큰 함께 전송
    			},
    			success:function(data){
    				//alert(data);
    				printFiles(data);
    			}
    		})
    	}
		
    	//첨부파일 출력
    	function printFiles(data){
    		// 파일 정보 처리
    	    var fileInfo = getFileInfo(data);
    		$("#ufilename").val(fileInfo.fullName);
    		$("#ufilepath").val(fileInfo.imgSrc);
    		console.log(fileInfo.fullName);
    		console.log(fileInfo.imgSrc);
    		$("#profile").attr("src",fileInfo.imgSrc);
    	    /* $("#userphoto").css("background-image","URL("+fileInfo.imgSrc+")")
			$("#userphoto").css("background-size","cover") */
			$("#userphoto_menu").hide();
        	$("#photobtn").show()
    	}
    	
    	// 파일 삭제(입력페이지) : 첨부파일만 삭제처리
    	function deleteFileWrtPage() {
    		var that = $("#ufilename").val();
    	    var url = "${pageContext.request.contextPath}/files/delete";
    	    deleteFile(url, that);
    	}
    	// 파일 삭제 AJAX 통신
    	function deleteFile(url, that) {
    		console.log(url);
    		console.log(that);
    	    $.ajax({
    	        url: url,
    	        type: "post",
    	        data: {fileName: that},
    	        dataType: "text",
    	        beforeSend: function(xhr){
    				xhr.setRequestHeader(header, token);	// 헤드의 csrf meta태그를 읽어 CSRF 토큰 함께 전송
    			},
    	        success: function (result) {
    	            if (result === "DELETED") {
    	               $("#userphoto").css("background-image","URL('')")
    	               $("#userphoto_menu").hide();
    	               alert("삭제되었습니다.");
    	            }
    	        }
    	    });
    	}
    	
    	// 파일 정보 처리
    	function getFileInfo(fullName) {

    	    var originalFileName;   // 화면에 출력할 파일명
    	    var imgSrc;             // 썸네일 or 파일아이콘 이미지 파일 출력 요청 URL
    	    var originalFileUrl;    // 원본파일 요청 URL
    	    var uuidFileName;       // 날짜경로를 제외한 나머지 파일명 (UUID_파일명.확장자)

    	    // 이미지 파일이면
    	    if (checkImageType(fullName)) {
    	        imgSrc = "${pageContext.request.contextPath}/files/display?fileName=" + fullName; // 썸네일 이미지 링크
    	        uuidFileName = fullName.substr(14);
    	        var originalImg = fullName.substr(0, 12) + fullName.substr(14);
    	        // 원본 이미지 요청 링크
    	        originalFileUrl = "${pageContext.request.contextPath}/files/display?fileName=" + originalImg;
    	    } else {
    	        alert("이미지 파일만 선택해주세요.")
    	        return false;
    	    }
    	    originalFileName = uuidFileName.substr(uuidFileName.indexOf("_") + 1);
    	    return {originalFileName: originalFileName, imgSrc: imgSrc, originalFileUrl: originalFileUrl, fullName: fullName};
    	}

    	// 이미지 파일 유무 확인
    	function checkImageType(fullName) {
    	    var pattern = /jpg$|gif$|png$|jpge$/i;
    	    return fullName.match(pattern);
		}
		





		// 파일 삭제(입력페이지) : 첨부파일만 삭제처리
    	function deleteFileWrtPage() {
    		let ufilename = $("#ufilename").val();
    		let dbufilename = $("#dbufilename").val();
    		let f = document.createElement("form");
    		f.setAttribute("method", "post");
    		
    		let frm = $("#profileform");
    		var delconfirm = confirm("정말 삭제하시겠습니까?")
    		if(delconfirm){
	    		/* if(ufilename===null || ufilename===""){
	    			// 사진편집이 실행 안 되었을 경우 DB삭제
	    			deleteFile(dbufilename);
	    			console.log("사진편집 안되었을 경우")
					frm.action= "${pageContext.request.contextPath}/user/mypage/delProfile";
					frm.method="post";
					frm.submit();
	    		} else { */
	    			// 사진편집이 실행 되었을 경우
	    			console.log(ufilename);
	    			console.log("사진편집");
	    			frm.action= "${pageContext.request.contextPath}/user/mypage/delPreviewProfile";
	    			frm.method="post";
	    			frm.submit();
	    			alert("??");
	    		/* } */
    		} else {
    			alert("삭제가 취소되었습니다.")
    		}
    	}
</script>

<c:choose>
			 	<c:when test="${empty userImage }">
				<div>
					<img id ="profileImg" src = "/displayFile?fileName=/lion.gif" style = "border-radius:0%; padding-top : 10px; height:100px; width:100px;">
				</div>
				</c:when>
				<c:otherwise>
				<div>
					<img id ="profileImg" src = "/displayFile?fileName=${userImage }" style = "border-radius:0%; padding-top : 10px; height:100px; width:100px;">
				</div>
				</c:otherwise>









				
</c:choose>