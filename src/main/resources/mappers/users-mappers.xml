<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Users">
	<resultMap type="UsersDto" id="resultUsers">
		<id property="uno" column="uno" />
		<result property="cno" column="cno" />
		<result property="dno" column="dno" />
		<result property="uemail" column="uemail" />
		<result property="uname" column="uname" />
		<result property="utell" column="utell" />
		<result property="upwd" column="upwd" />
		<result property="utmppwd" column="utmppwd" />
		<result property="urank" column="urank" />
		<result property="uregdate" column="uregdate" />
		<result property="uresdate" column="uresdate" />
		<result property="ustate" column="ustate" />
		<result property="ufilename" column="ufilename" />
		<result property="ufilepath" column="ufilepath" />
		<result property="uauthority" column="uauthority" />
		<result property="enabled" column="enabled" />
		<result property="failure_cnt" column="failure_cnt"/>
	</resultMap>
	
	<!-- 가입 -->
	<insert id="joinBusiness" flushCache="true">
		INSERT INTO USERS(uno, cno, uemail, uname, upwd, urank, uauthority, enabled) 
		VALUES(UNO_SE.NEXTVAL, CNO_SE.CURRVAL, #{uemail} , #{uname} , #{upwd} , '대표', 'ROLE_ADMIN', 1 )
	</insert>
	
	<!-- 이메일 중복체크 -->
	<select id="emailChk" resultType="int">
		select count(*) from users
		where uemail = #{uemail}
	</select>
	
	
	
	
	<!-- ####### 여기부터 시큐리티 ####### -->
	<!-- 유저 정보 가져오기 -->
	<select id="selectUserById" resultType="com.kh.ontact.users.model.dto.CustomUserDetails">
        <![CDATA[
            SELECT
                *
            FROM
                users
            WHERE
                uemail=#{uemail}
        ]]>
    </select>
    <!-- 로그인 실패 횟수 -->
    <update id="updateFailureCount">
        <![CDATA[
            UPDATE
                users
            SET
                FAILURE_CNT = FAILURE_CNT + 1
            WHERE
                uemail = #{ uemail}
        ]]>
    </update>
    <select id="checkFailureCount" resultType="Integer">
        <![CDATA[
            SELECT
                FAILURE_CNT
            FROM
                users
            WHERE
                uemail=#{uemail}
        ]]>
    </select>
    <!-- 비밀번호 10번이상 틀릴시 계정 비활성화 -->
    <update id="updateUnenabled">
		<![CDATA[
			UPDATE
				users
			SET
				ENABLED = 0
			WHERE
				uemail = #{uemail}
		]]>
	</update>
    <!-- 로그인실패횟수 초기화 -->
    <update id="updateFailureCountReset">
	<![CDATA[
			UPDATE
				users
			SET
				FAILURE_CNT = 0
			WHERE
				uemail = #{uemail}
		]]>
	</update>
	
	
	
	
	
	<!-- 아래부터  혜원 채팅 관련 코드  -->
	
	<!-- 해당 cno의 내 정보 빼고 users list 불러오기 -->
	<select id="ChatUsersList" resultType="arraylist" resultMap="resultUsers" >
 	<![CDATA[
		SELECT * FROM USERS WHERE CNO=#{cno} AND UNO NOT IN (#{uno})
		]]>
	</select>

</mapper>