<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Project">

	<!-- 프로젝트 전체 목록 -->
	<select id="selectListProject" resultMap="projectListMap">
		<![CDATA[
			select pj.pno as pj_pno, pj.pname as pj_pname, pj.popen as pj_open, pjm.pjmembercnt as pjmembercnt, pjteam.dname as pjteam
			    from project pj 
			        inner join 
			        (select pj.pno, count(uno) as pjmembercnt
			            from project_member pjm, project pj 
			            group by pj.pno 
			            having pj.pno = pjm.pno) pjm 
			        on pj.pno = pjm.pno
			        left join
			        (select pjd.pno, LISTAGG(d.dname,',') WITHIN GROUP(ORDER BY d.dname) AS dname 
			            from project_dept pjd, dept d 
			            where d.dno = pjd.dno 
			            group by pjd.pno) pjteam 
			        on pj.pno = pjteam.pno 
			    order by pj.pno asc
	     ]]>
	</select>
	<resultMap type="map" id="projectListMap">
		<id column="pj_pno" property="pno"/>
		<result column="pj_pname" property="pname"/>
		<result column="pj_open" property="popen"/>
		<result column="pjmembercnt" property="pjmembercnt"/>
		<result column="pjteam" property="pjteam"/>
	</resultMap>


	<!-- 프로젝트 생성 -->
	<insert id="insertProject" parameterType="string"
		flushCache="true" statementType="PREPARED">
		<![CDATA[
		insert into project values(
		PNO_SE.NEXTVAL, #{pname}, #{pdesc}, sysdate, #{popen}
		)
		 ]]>
	</insert>

	<!-- 프로젝트 업데이트 : 부서이동 <update> </update> -->
</mapper>
